# å‰ç«¯-æ³¨å†Œä¸ç™»å½•

[toc]

## 1ã€ä¿¡æ¯æç¤º

åˆ›å»º `Message` ç»„ä»¶ï¼Œç”¨äºå¤„ç†åº”ç”¨æç¤ºã€‚

### 1-1ã€ç»„ä»¶è®¾è®¡

```vue
// file: trello-vue/src/components/TMessage/Index.vue

<template>
    <transition name="message-fade" @after-leave="handleAfterLeave">
        <div
            :class="[
                'message',
                'message-' + type,
                center ? 'is-center' : ''
            ]"
            :style="positionStyle"
            v-show="!closed"
        >
            <p class="message-content">æç¤ºä¿¡æ¯ï¼š{{message}}</p>
            <i class="icon icon-close"></i>
        </div>
    </transition>
</template>

<script>

    export default {
        name: 'TMessage',

        data() {
            return {
                closed: false,
                type: 'info',
                message: '',
                center: true,
                verticalOffset: 20,
                duration: 1000,
                timer: null,
                onClose: null
            }
        },

        mounted() {
            this.startTimer();
        },

        computed: {
            positionStyle() {
                return {
                    'top': `${ this.verticalOffset }px`
                };
            }
        },

        methods: {
            clearTimer() {
                clearTimeout(this.timer);
            },

            startTimer() {
                if (this.duration > 0) {
                    this.timer = setTimeout(() => {
                        if (!this.closed) {
                            this.close();
                        }
                    }, this.duration);
                }
            },

            handleAfterLeave() {
                this.$destroy();
                this.$el.parentNode.removeChild(this.$el);
            },

            close() {
                this.closed = true;
                if (typeof this.onClose === 'function') {
                    this.onClose(this);
                }
            }
        }
    }
</script>
```

### 1-2ã€åŠŸèƒ½ç»„ä»¶è®¾è®¡

æˆ‘ä»¬å¸Œæœ› `Message` ç»„ä»¶ä¸ä»…ä»…åªèƒ½é€šè¿‡æ ‡ç­¾ï¼ˆUIï¼‰çš„æ–¹å¼è¿›è¡Œè°ƒç”¨ï¼Œè¿˜èƒ½å¤Ÿåœ¨ `js` ä¸­è¿›è¡Œç›´æ¥è°ƒç”¨ã€‚æˆ‘ä»¬éœ€è¦å¯¹ `Message` è¿›è¡Œç‰¹æ®Šå¤„ç†ï¼Œå…¶æ ¸å¿ƒå°±æ˜¯ï¼š

- ç»„ä»¶çš„ `$mount` æ–¹æ³•ã€‚

å½“ç„¶ï¼Œè¿™å…¶ä¸­è¿˜åŒ…æ‹¬å…¶å®ƒä¸€äº›ç»†èŠ‚ï¼š

- ç»Ÿä¸€ç®¡ç†åº”ç”¨ä¸­å¤šä¸ª `Message` å®ä¾‹çš„é˜Ÿåˆ—ã€‚

```js
// file: trello-vue/src/components/TMessage/Index.js

import Vue from 'vue';
import TMessage from "./TMessage.vue";

let TMessageConstructor = Vue.extend(TMessage);

let instance;
let instances = [];
let seed = 1;

const Message = function(options) {
    options = options || {};
    if (typeof options === 'string') {
        options = {
            message: options
        };
    }
    let userOnClose = options.onClose;
    let id = 'message_' + seed++;

    options.onClose = function() {
        Message.close(id, userOnClose);
    };
    instance = new TMessageConstructor({
        data: options
    });
    instance.id = id;

    instance.$mount();
    document.body.appendChild(instance.$el);

    let verticalOffset = options.offset || 20;
    instances.forEach(item => {
        verticalOffset += item.$el.offsetHeight + 16;
    });
    instance.verticalOffset = verticalOffset;
    instance.$el.style.zIndex = 1000000 + seed;
    instances.push(instance);
    return instance;
};

['success', 'warning', 'info', 'error'].forEach(type => {
    Message[type] = options => {
        if (typeof options === 'string') {
            options = {
                message: options
            };
        }
        options.type = type;
        return Message(options);
    };
});

Message.close = function(id, userOnClose) {
    let len = instances.length;
    let index = -1;
    let removedHeight;
    for (let i = 0; i < len; i++) {
        if (id === instances[i].id) {
            removedHeight = instances[i].$el.offsetHeight;
            index = i;
            if (typeof userOnClose === 'function') {
                userOnClose(instances[i]);
            }
            instances.splice(i, 1);
            break;
        }
    }
    if (len <= 1 || index === -1 || index > instances.length - 1) return;
    for (let i = index; i < len - 1 ; i++) {
        let dom = instances[i].$el;
        dom.style['top'] =
            parseInt(dom.style['top'], 10) - removedHeight - 16 + 'px';
    }
};

Message.closeAll = function() {
    for (let i = instances.length - 1; i >= 0; i--) {
        instances[i].close();
    }
};

export default Message;
```

### 1-3ã€æŒ‚è½½ä¸ºå…¨å±€é€šç”¨æ–¹æ³•

```js
// file: trello-vue/src/main.js

// ...
import message from '@/components/TMessage/Index'

Vue.prototype.$message = message;

// ...
```





## 2ã€ğŸ‰ ä»£ç†é…ç½®

### 2-1ã€å®‰è£… axios

é¡¹ç›®ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ `axios` ä½œä¸ºè¯·æ±‚åº“ã€‚

```shell
yarn add axios
```

### 2-2ã€é…ç½®ä»£ç†

é€šè¿‡ `vue.config.js` é…ç½®ä»£ç†ï¼Œè§£å†³å¼€å‘è¿‡ç¨‹ä¸­çš„è·¨åŸŸé—®é¢˜ã€‚

```js
// file: trello-vue/vue.config.js

module.exports = {
    devServer: {
        proxy: {
            '/api': {
                target: 'http://localhost:9090',
                pathRewrite: {
                    '^/api': '/api/v1'
                }
            }
        }
    }
};
```



## 3ã€ä½¿ç”¨ vuex è¿›è¡ŒçŠ¶æ€ç®¡ç†

### 3-1ã€é¡¹ç›®é…ç½®

```
// file: trello-vue/.env.development

VUE_APP_SERVER_API_PATH = /api
VUE_APP_SERVER_STATIC_PATH = http://localhost:8080
```

### 3-2ã€api ç®¡ç†

ç‹¬ç«‹åˆ›å»ºä¸€ä¸ªæ–‡ä»¶ç®¡ç†æ‰€æœ‰çš„ api è¯·æ±‚

```js
// file: trello-vue/src/api/index.js

import axios from 'axios';
import TMessage from "@/components/TMessage/Index";

axios.defaults.baseURL = process.env.VUE_APP_SERVER_API_PATH;

axios.interceptors.request.use( configs => {
    return configs;
} );

axios.interceptors.response.use( response => {
    return response;
}, error => {
    TMessage.error(error.response.data.message);
    throw error;
} );

export const register = (data) => {
    return axios({
        method: 'post',
        url: '/user/register',
        data
    });
};
```

### 3-3ã€store ç»“æ„

```js
// file: trello-vue/src/store/index.js

import Vue from 'vue';
import Vuex from 'vuex';

import user from './user';
import board from './board';
import list from './list';
import card from './card';
import comment from './comment';

Vue.use(Vuex);

export default new Vuex.Store({
    state: {
        server: {
            staticPath: process.env.VUE_APP_SERVER_STATIC_PATH
        }
    },
    mutations: {
    },
    actions: {
    },
    modules: {
        user,
        board,
        list,
        card,
        comment
    }
})

```

```js
// file: trello-vue/src/store/user/index.js

import {register, login} from '@/api';

export default {
    namespaced: true,
    state: {
        info: null
    },
    mutations: {
    },
    actions: {
        register: async ({}, data) => {
            return register(data);
        }
    }
}
```



## 3ã€ğŸŠ æ³¨å†Œ

```vue
// file: trello-vue/src/views/register.vue

<template>
    <div id="register-login">
        <a class="logo" href="/"></a>

        <div class="section-wrapper">
            <div class="account-form">
                <h1>æ³¨å†Œ Trello</h1>
                <form id="login-form" method="POST" @submit.prevent="registerSubmit">
                    <div>
                        <label>
                            <input class="form-field" autofocus="autofocus" placeholder="è¾“å…¥ç”¨æˆ·å" v-model="user.name" />
                        </label>
                    </div>
                    <div>
                        <label>
                            <input type="password" class="form-field" placeholder="è¾“å…¥å¯†ç " v-model="user.password" />
                        </label>
                    </div>
                    <div>
                        <label>
                            <input type="password" class="form-field" placeholder="å†æ¬¡ç¡®è®¤å¯†ç " v-model="user.rePassword" />
                        </label>
                    </div>
                    <div>
                        <input type="submit" class="btn btn-success" value="æ³¨å†Œ" />
                        <span class="signin-signup-separator">æˆ–è€…</span>
                        <input type="button" class="btn" value="ç™»å½•"/>
                    </div>
                </form>
            </div>

        </div>
    </div>
</template>

<script>

    export default {
        name: 'Register',

        data() {
            return {
                user: {
                    name: '',
                    password: '',
                    rePassword: ''
                }
            }
        },

        methods: {
            async registerSubmit() {

                if (this.user.name.trim() === '' || this.user.password.trim() === '') {
                    return this.$message.error('ç”¨æˆ·åå’Œå¯†ç ä¸èƒ½ä¸ºç©º');
                }
                if (this.user.password !== this.user.rePassword) {
                    return this.$message.error('ä¸¤æ¬¡å¯†ç ä¸ä¸€è‡´');
                }

                try {
                    await this.$store.dispatch('user/register', {
                        ...this.user
                    });
                    this.$router.push({name: 'Login'});
                } catch (e) {}
            }
        }
    }
</script>
```



## 4ã€ç™»å½•éªŒè¯ä¸ç”¨æˆ·ä¿¡æ¯å­˜å‚¨

ç™»å½•éªŒè¯çš„é€»è¾‘ä¸æ³¨å†Œé€»è¾‘åŸºæœ¬ä¸€è‡´ï¼Œåªæ˜¯éœ€è¦æŠŠç™»å½•æˆåŠŸåçš„ç”¨æˆ·ä¿¡æ¯ï¼ŒåŒ…æ‹¬ `token` è¿›è¡Œå­˜å‚¨ï¼š

- å­˜å‚¨åœ¨ `localStorage` ä¸­ï¼Œè¿›è¡ŒæŒä¹…åŒ–ï¼Œé¿å…é¡µé¢åˆ·æ–°æˆ–å…³é—­é‡æ–°è¿›å…¥ä¸¢å¤±æ•°æ®ã€‚
- æ¯æ¬¡è¿›å…¥åº”ç”¨ï¼ˆåŒ…æ‹¬åˆ·æ–°ï¼‰ï¼Œä» `localStorage` ä¸­è¯»å–ç”¨æˆ·æ•°æ®ï¼Œå¹¶å­˜å…¥ `vuex` ä¸­

### 4-1ã€è·¯ç”±ç»Ÿä¸€é‰´æƒ

```js
// file: trello-vue/src/router/index.js

// ...
import store from '@/store'

const routes = [
  {
    path: '/',
    name: 'Home',
    // æ·»åŠ é‰´æƒæ ‡è¯†
    meta: {
      requiresAuth: true
    },
    component: Home
  },
  {
    path: '/board/:id(\\d+)',
    name: 'Board',
    meta: {
      // æ·»åŠ é‰´æƒæ ‡è¯†
      requiresAuth: true
    },
    component: Board,
    children: [
      {
        path: 'list/:listId(\\d+)/card/:cardId(\\d+)',
        name: 'Card',
        component: Card
      }
    ]
  },
  {
    path: '/login',
    name: 'Login',
    component: Login
  },
  {
    path: '/register',
    name: 'Register',
    component: Register
  },
  {
    path: '*',
    name: 'NotFound',
    component: NotFound
  }
];

store.commit('user/initUserInfo');
router.beforeEach((to, from, next) => {
  // å¦‚æœè¯¥è·¯ç”±éœ€è¦æˆæƒè®¿é—®ï¼Œåˆ™éªŒè¯ç”¨æˆ·ä¿¡æ¯
  if (
      to.matched.some( matched =>  matched.meta.requiresAuth)
      &&
      !store.state.user.info
  ) {
    next({
      name: 'Login'
    });
  } else {
    next();
  }
});

// ...
```

### 4-2ã€è¯·æ±‚æ‹¦æˆª

```js
// file: trello-vue/src/api/index.js

// ...
axios.interceptors.request.use( configs => {

    try {
        let storageData = JSON.parse(localStorage.getItem('user'));
        if (storageData.authorization) {
            configs.headers.common.authorization = storageData.authorization;
        }
    }catch (e) {}

    return configs;
} );
// ...
```

