# åç«¯-æ³¨å†Œ

[toc]

## 1ã€ğŸ‰ ç”¨æˆ·æ³¨å†Œ

```typescript
// file: backend/src/controllers/User.ts

import {
    Controller,
    Post,
    Body
} from 'koa-ts-controllers';
import {RegisterBody} from '../validators/User';

@Controller('/user')
export class UserController {

    @Post('/register')
    async register(
        @Body() query: RegisterBody
    ) {
        // æ³¨å†Œé€»è¾‘
    }

}
```



## 2ã€ğŸ“ RegisterBody éªŒè¯ç±»

```typescript
// file: backend/src/validators/User.ts

import {IsNotEmpty, Length, ValidateIf} from 'class-validator';
import {IsSameValue} from './CustomValidationDecorators';

export class RegisterBody {
    @Length(1, 50, {
        message: 'ç”¨æˆ·åä¸èƒ½ä¸ºç©ºæˆ–è€…å¤§äº50ä¸ªå­—ç¬¦é•¿åº¦'
    })
    name: string;

    @IsNotEmpty({
        message: 'å¯†ç ä¸èƒ½ä¸ºç©º'
    })
    password: string;

    @ValidateIf(o => o.password)
    @IsSameValue('password', {
        message: 'ä¸¤æ¬¡è¾“å…¥å¯†ç ä¸ä¸€è‡´'
    })
    rePassword: string;
}
```

### 2-1ã€è‡ªå®šä¹‰éªŒè¯è£…é¥°å™¨

https://www.npmjs.com/package/class-validator#custom-validation-decorators

```typescript
// file: backend/src/validators/CustomValidationDecorators.ts

import {registerDecorator, ValidationOptions, ValidationArguments} from "class-validator";

export function IsSameValue(property: string, validationOptions?: ValidationOptions) {
    return function (object: Object, propertyName: string) {
        registerDecorator({
            name: "isSameValue",
            target: object.constructor,
            propertyName: propertyName,
            constraints: [property],
            options: validationOptions,
            validator: {
                validate(value: any, validationArguments: ValidationArguments): Promise<boolean> | boolean {
                    // æ ¹æ®ä¸Šé¢çš„å±æ€§åç§°è·å–å¯¹åº”çš„å€¼
                    const relatedValue = (validationArguments.object as any)[property];
                    // æ¯”è¾ƒå½“å‰è£…é¥°å™¨è£…é¥°å±æ€§å€¼ä¸ä¼ å…¥çš„ç¬¬ä¸€ä¸ªå‚æ•°çš„å€¼æ˜¯å¦ç›¸åŒ
                    return relatedValue === value;
                }
            }
        });
    };
}
```



## 3ã€ğŸŠ æ³¨å†Œé€»è¾‘

```typescript
import {
    Controller,
    Post,
    Body,
    Ctx
} from 'koa-ts-controllers';
import {RegisterBody} from '../validators/User';
import {Context} from "koa";
import Boom from '@hapi/Boom';
import {User as UserModel} from '../models/User';

@Controller('/user')
export class Controller {

    @Post('/register')
    async register(
        @Ctx() ctx: Context,
        @Body() body: RegisterBody
    ) {
        let {name, password} = body;

        let where = {name};
        let user = await UserModel.findOne({where});
        if (user) {
            throw Boom.conflict('ç”¨æˆ·åå·²ç»è¢«æ³¨å†Œäº†');
        }

        let newUser = new UserModel();
        newUser.name = name;
        newUser.password = password;
        await newUser.save();

        ctx.status = 201;
        return {
            id: newUser.id,
            name,
            createAt: newUser.createdAt
        };
    }

}
```

### 3-1ã€æ•°æ®åº“æ“ä½œ

å‰é¢æˆ‘ä»¬é€šè¿‡ç±»å®šä¹‰äº†æ•°æ®åº“æ¨¡å‹ï¼Œæ¯ä¸€ä¸ªç±»å¯¹åº”ä¸€å¼ è¡¨ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥ç›´æ¥é€šè¿‡è¿™ä¸ªæ¨¡å‹ç±»æä¾›çš„æ“ä½œæ¥å¯¹å¯¹åº”çš„è¡¨è¿›è¡Œæ“ä½œäº†ã€‚

https://sequelize.org/master/class/lib/model.js~Model.html

è®°ä½è¿™ä¸ªç‰¹ç‚¹ï¼š

- ç±»å¯¹åº”çš„è¡¨ï¼Œç±»çš„æ–¹æ³•ï¼ˆé™æ€æ–¹æ³•ï¼‰å¯¹åº”çš„å°±æ˜¯å¯¹è¡¨çš„æ“ä½œã€‚
- ç±»å®ä¾‹å‡ºæ¥çš„å¯¹è±¡å¯¹åº”çš„æ˜¯è¡¨ä¸­æŸæ¡æ•°æ®ï¼Œå¯¹å¯¹è±¡çš„æ“ä½œå°±æ˜¯å¯¹æ•°æ®çš„æ“ä½œã€‚



## 4ã€ğŸ‡ æ·»åŠ  postman æµ‹è¯•

ä¸ºäº†æ–¹ä¾¿ç»„ç»‡ç®¡ç†è¯·æ±‚ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡æ–‡ä»¶å¤¹æœ‰æ•ˆçš„å»ç»„ç»‡å®ƒä»¬ã€‚

- ç”¨æˆ·
  - æ³¨å†Œ
  - ç™»å½•

æµ‹è¯•ä¸ä»…ä»…åªæ˜¯æµ‹è¯•æ­£ç¡®æ€§ï¼Œæ›´é‡è¦çš„æ˜¯é”™è¯¯é¢„æµ‹ã€‚ç”¨æˆ·æ³¨å†Œçš„è¯·æ±‚è‡³å°‘æœ‰ï¼š

- ç”¨æˆ·åä¸èƒ½ä¸ºç©º
- ç”¨æˆ·åä¸èƒ½å¤§äº50ä¸ªå­—ç¬¦
- å¯†ç ä¸èƒ½ä¸ºç©º
- ä¸¤æ¬¡è¾“å…¥å¯†ç ä¸ä¸€è‡´
- ç”¨æˆ·åå·²ç»è¢«æ³¨å†Œ
- æ³¨å†ŒæˆåŠŸ

åŒæ—¶ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥æ·»åŠ æµ‹è¯•æ–­è¨€è„šæœ¬ï¼Œé”™è¯¯æƒ…å†µä¸‹æµ‹è¯•ä¸€ä¸‹è¿”å›çŠ¶æ€ç ï¼ŒæˆåŠŸçŠ¶æ€ç ä¸‹æµ‹è¯•çŠ¶æ€ç çš„åŒæ—¶ï¼Œåˆ©ç”¨ `JSON Schema` å¯¹è¿”å›çš„æ•°æ®è¿›è¡Œç»“æ„åŒ–æµ‹è¯•ï¼Œå¦‚ï¼š

```js
const Ajv = require('ajv');
const ajv = new Ajv({logger: console});
const schema = {
  	required: ["id", "name", "createAt"],
		properties: {
    		id: {
      			type: "number"
    		},
      	name: {
          	type: "string"
        },
      	createAt: {
          	type: "string",
          	format: "date-time"
        }
  	}
};

pm.test("çŠ¶æ€ç ä¸º201", function () {
    pm.response.to.have.status(201);
});

pm.test('Schema is valid', function() {
    pm.expect(ajv.validate(schema, 			pm.response.json())).to.be.true;
});
```

